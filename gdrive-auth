#!/usr/bin/env bash
set -euo pipefail

# gdrive-auth: OAuth2 authentication wrapper around oauth2c
# Outputs token JSON to stdout

# Source config from .env (cwd) or ~/.config/gdrive-auth/config
if [[ -f ".env" ]]; then
    set -a
    source ".env"
    set +a
elif [[ -f "$HOME/.config/gdrive-auth/config" ]]; then
    set -a
    source "$HOME/.config/gdrive-auth/config"
    set +a
fi

# Validate required env vars
if [[ -z "${GOOGLE_CLIENT_ID:-}" ]]; then
    echo "Error: GOOGLE_CLIENT_ID not set" >&2
    exit 1
fi

if [[ -z "${GOOGLE_CLIENT_SECRET:-}" ]]; then
    echo "Error: GOOGLE_CLIENT_SECRET not set" >&2
    exit 1
fi

SCOPES="${GOOGLE_SCOPES:-https://www.googleapis.com/auth/drive.readonly}"

usage() {
    cat >&2 <<EOF
Usage: gdrive-auth [OPTIONS]

Options:
  --grant-type TYPE     OAuth2 grant type (authorization_code, refresh_token)
                        Default: authorization_code
  --refresh-token TOKEN Refresh token (required for refresh_token grant)
  -h, --help            Show this help message

Environment Variables:
  GOOGLE_CLIENT_ID      Google OAuth2 client ID (required)
  GOOGLE_CLIENT_SECRET  Google OAuth2 client secret (required)
  GOOGLE_SCOPES         OAuth2 scopes (default: https://www.googleapis.com/auth/drive.readonly)

Config files (sourced in order of precedence):
  .env                  Current working directory
  ~/.config/gdrive-auth/config
EOF
    exit 1
}

# NOTE: Google doesn't support Drive API scopes in device authorization flow.
GRANT_TYPE="authorization_code"
REFRESH_TOKEN=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        --grant-type)
            GRANT_TYPE="$2"
            shift 2
            ;;
        --refresh-token)
            REFRESH_TOKEN="$2"
            shift 2
            ;;
        -h|--help)
            usage
            ;;
        *)
            echo "Error: Unknown option: $1" >&2
            usage
            ;;
    esac
done

case "$GRANT_TYPE" in
    authorization_code)
        exec oauth2c https://accounts.google.com \
            --client-id "$GOOGLE_CLIENT_ID" \
            --client-secret "$GOOGLE_CLIENT_SECRET" \
            --response-types code \
            --grant-type authorization_code \
            --auth-method client_secret_post \
            --scopes "$SCOPES" \
            --pkce \
            --silent
        ;;
    refresh_token)
        if [[ -z "$REFRESH_TOKEN" ]]; then
            echo "Error: --refresh-token required for refresh_token grant" >&2
            exit 1
        fi
        exec oauth2c https://accounts.google.com \
            --client-id "$GOOGLE_CLIENT_ID" \
            --client-secret "$GOOGLE_CLIENT_SECRET" \
            --grant-type refresh_token \
            --auth-method client_secret_post \
            --refresh-token "$REFRESH_TOKEN" \
            --silent
        ;;
    *)
        echo "Error: Unsupported grant type: $GRANT_TYPE" >&2
        exit 1
        ;;
esac
